# import cvxpy
import numpy as np
import matplotlib.pyplot as plt
import japanize_matplotlib
# from scipy.integrate import odeint

# import cvxopt
# from cvxopt import matrix
import scipy.linalg
import scipy.signal
from l1sample import mpc_modeling_tool_v5
import random
import csv
import pandas as pd
import torch
import torch.nn as nn
import torch.nn.functional as F
import torch.optim as optim
from torch.utils.data import Dataset
from sklearn.model_selection import train_test_split
from torchvision import datasets, transforms
from torch.utils.data import DataLoader, Dataset
import time
from operator import mul
from network import netC as Net

# モデルの定義


device = torch.device("cuda" if torch.cuda.is_available() else "cpu")
model = Net().to(device)
# print(len(dataset)) #36300 =11*11*300

# optimizer = optim.Adam(net.parameters())
# fn_loss=nn.BCEWithLogitsLoss()
# losses=[]
# running_loss=0.0
# cntfile=[]
# cnt=0
# epoches=10
# batch_size=100

model.load_state_dict(torch.load("./params/model_C.pth", map_location=device))

print("----------------------------")

#学習終わり,推論はじめ
print("---------------------")
A = np.array([[0, -1],
                [2, 0]])
B = np.array([[2], [0]])

C = np.array([[1], [0]])
(nx, nu) = B.shape
Q = np.eye(nx)
R = np.eye(nu)

Ts = 0.05
Th = 3
N=int(Th/Ts)
# a=1 #L1差分ノルム
# b=0.5 #L1ノルム
# c=1 #L2ノルム

Ad, Bd, _, _, dt = scipy.signal.cont2discrete((A,B,C,0),Ts)

# # print(Ad)
# # print(Bd)

x0 = np.array([[1.28], [-1.89]]) # init state

simutime=10/3
simutime=1/Th
# simutime=5
itr=int(simutime*Th)

rx0 =[]
rx1 =[]
ru=[]
noiseLi=[]

xcurr = x0
ucurr = 0

t1 = time.time()
l2norm = 0
l1norm = 0

# noisedf = pd.read_csv('./dataset/noise.csv')
# noiseLi = noisedf.values.tolist()

t1 = time.time()
for count in range(itr):

    # 分類
    data = [xcurr[0,0], xcurr[1,0]]
    data = torch.tensor(data, dtype=torch.float32)
    output = model(data)
    # output = torch.sigmoid(output)
    output = output.detach().tolist()

    if count ==0:
        print("out", output)

    Signs = [] #分類のみ用
    for fm in range(0, 180, 3):
        cnt = [output[fm], output[fm+1], output[fm+2]]

        sign = cnt.index(max(cnt)) - 1
        Signs.append(sign) #分類のみ用

    # 分類のみの場合
    ucurr = Signs
    for horizon in range(N):
        ru.append(ucurr[horizon])
        rx0.append(xcurr[0][0])
        rx1.append(xcurr[1][0])
        l1norm += abs(ucurr[horizon])
        l2norm += (xcurr[0])**2

        #外乱を与える
        noise = 0
        # noise = noiseLi[count*N+horizon][0]

        xnext = Ad@xcurr + Bd*(ucurr[horizon]+noise) # x(i) → x(i+1)

        xcurr = xnext
t2 = time.time()

ru2 = [-0.9009271635697995, -0.9009262995968638, -0.9009253090776699, -0.9009241965553542, -0.9009229753001472, -0.9009216564341495, -0.9009202524901503, -0.9009187772889311, -0.9009172473872501, -0.9009156785460305, -0.9009140885657473, -0.9009124956202668, -0.9009109178681431, -0.900909374710436, -0.9009078876030917, -0.9009064674257657, -0.9009051423513814, -0.9009039250738411, -0.9009028329847374, -0.9009018915374228, -0.9009011030251621, -0.9009004809947958, -0.8962397253804164, -0.018484534032767928, 0.027122768468151176, 0.012133816212802412, 0.0096629648538398, 0.009868496667018244, 0.009264490518152643, 0.008516087764241322, 0.007214878839902782, 0.006872140182535808, 0.006002533789579403, 0.005630302243848495, 0.004930793593546048, 0.004577052365569368, 0.004103411060122684, 0.0037077355088041388, 0.0034113671531601614, 0.0030457733288326337, 0.002778682825160166, 0.0025305240489874284, 0.002298565833343362, 0.002089830465363771, 0.0019039736400798854, 0.001737891731410628, 0.0015890568928893754, 0.0014558309684774581, 0.0013370385186859165, 0.001231841282169858, 0.0011396732155430152, 0.0010592627635550417, 0.0009867002038901256, 0.0009193184197959665, 0.0008793382533840279, 0.0008534620440642412, 0.000751707829905243, 0.0008064518703096973, 0.0007485686805891271, 0.0007312869539752524]
rx02 = [1.28, 1.2812049449358567, 1.2760066202044933, 1.2644310192456114, 1.2465360081423367, 1.2224110355393558, 1.1921766858006468, 1.1559840761978841, 1.1140141015101621, 1.0664765296535332, 1.0136089533578865, 0.9556756024944169, 0.8929660234393473, 0.8257936319466991, 0.7544941465982153, 0.679423910704432, 0.6009581123871311, 0.5194889076923579, 0.43542346217365824, 0.34918191544305355, 0.2611952805426217, 0.17190329209115968, 0.08175220740263074, -0.00834178077197198, -0.010691686265319696, -0.008431225006385941, -0.007626271642958037, -0.00703008208981978, -0.006378220711847848, -0.005754831809684814, -0.005177458659793107, -0.004704221486639191, -0.004241718316201702, -0.0038449035798345465, -0.003466064477480607, -0.0031397948597176204, -0.002833177459535962, -0.0025597247438282436, -0.002313013326684057, -0.0020843538052561896, -0.0018818057803784898, -0.0016965394447632574, -0.00152758914868098, -0.0013741805853473162, -0.0012347601280181283, -0.0011077386403682563, -0.0009917751210882777, -0.0008857258761059629, -0.0007885613397538778, -0.0006993249873482526, -0.0006171044260967212, -0.000541008756045079, -0.00047024351512976964, -0.00040437824674759636, -0.00034322449411033077, -0.0002843500197278589, -0.00022663985266412382, -0.00017796390244242087, -0.00012292866022740493, -7.306252734861759e-05, -2.455796689881522e-05, -4.899843781978209e-05, -7.319401861471703e-05, -9.702378177870482e-05, -0.000120368628132992, -0.00014311188207279856, -0.00016513987470230827, -0.00018634251194237696, -0.00020661382477160382, -0.00022585249885070642, -0.00024396238088318076, -0.00026085295918149774, -0.0002764398160370064, -0.0002906450496326359, -0.0003033976633897129, -0.00031463392080296977, -0.0003242976639903086, -0.000332340594365236, -0.0003387225140291896, -0.0003434115266773001, -0.0003463841970134751, -0.00034762566787806503, -0.0003471297345027135, -0.00034489887552127484, -0.000340944240581808, -0.0003352855946215604, -0.00032795121908345227, -0.0003189777705677715, -0.0003084100976255276, -0.00029630101660911557, -0.0002827110477005694, -0.00026770811243671496, -0.0002513671942429653, -0.00023376996367238299, -0.00021500437022303355, -0.0001951642027736926, -0.000174348620834813, -0.00015266165895752045, -0.0001302117067775603, -0.00010711096729289315, -8.347489608242204e-05, -5.9421624268590596e-05, -3.5071368107836087e-05, -1.054582815971615e-05, 1.4032418962388454e-05, 3.8540533219015356e-05, 6.285602508894379e-05, 8.685736776165671e-05, 0.00011042460451825475, 0.00013343994826518248, 0.0001557883702243473, 0.0001773581748374067, 0.00019804155801089943, 0.00021773514591215856, 0.00023634051162314847, 0.0002537646670700332, 0.0002699205277698526, 0.00028472734807154156, 0.0002981111247159931, 0.0003100049666982063, 0.0003203494295829781, 0.0003290928126032575, 0.00033619141705628865, 0.0003416097647061012, 0.00034532077510078914, 0.0003473059009183623, 0.00034755522066472227, 0.0003460674882604669, 0.0003428501392686915, 0.0003379192537326615, 0.0003312994758090909, 0.0003230238905986919, 0.0003131338587895871, 0.0003016788099400228, 0.0002887159954335389, 0.0002743102023413048, 0.00025853342962171426, 0.00024146452827556635, 0.00022318880725530682, 0.00020379760709796335, 0.00018338784341272144, 0.00016206152250475237, 0.0001399252315561651, 0.00011708960591211528, 9.366877613453137e-05, 6.977979758703744e-05, 4.554206540195969e-05, 2.107671775336326e-05, -3.4939695814889815e-06, -2.8047194346323998e-05, -5.2460241561344545e-05, -7.661109684251456e-05, -0.00010037905621932505, -0.00012364532940322198, -0.0001462936334916105, -0.0001682107741401522, -0.0001892872112987046, -0.0002094176066834015, -0.00022850135024865404, -0.0002464430630278093, -0.0002631530738293107, -0.0002785478674058715, -0.0002925505018567507, -0.0003050909931769874, -0.00031610666503165, -0.00032554246200695706, -0.00033335122477266637, -0.000339493925780494, -0.0003439398643205619, -0.000346666819960998, -0.0003476611636038111, -0.0003469179256019911, -0.00034444082059739256, -0.0003402422289552632, -0.0003343431348882054, -0.0003267730215788232, -0.00031756972382522244, -0.00030677923894582946, -0.00029445549688861077, -0.00028066009069366846, -0.0002654619686563374, -0.0002489370897293267, -0.00023116804388617748, -0.00021224363934342928, -0.00019225845870452342, -0.00017131238624380014, -0.0001495101086931844, -0.00012696059202658722, -0.0001037765368570109, -8.007381516823768e-05, -5.597089119627061e-05, -3.1588229354912906e-05, -7.047692164624633e-06, 1.7528068806241648e-05, 4.201622594380114e-05, 6.629438947085802e-05, 9.024121914085517e-05, 0.00011373703068635695, 0.0001366643939910857, 0.00015890871999589784, 0.00018035883340539213, 0.00020090752833281004, 0.00022045210410616124, 0.0002388948785576595, 0.00025614367623109094, 0.0002721122890670949, 0.00028672090726389055, 0.00029989651816004326, 0.00031157327114568717, 0.0003216928067784087, 0.00033020454845889675, 0.00033706595520858877, 0.0003422427342859516, 0.00034570901257875735, 0.0003474474659157517, 0.0003474494056514239, 0.00034571482209113606, 0.0003422523845395761, 0.0003370793979722924, 0.00033022171654686195, 0.00032171361438595655, 0.0003115976142781219, 0.00029992427515240913, 0.0002867519393890431, 0.0002721464412290478, 0.000256180777740173, 0.00023893474398360722, 0.000220494534204884, 0.00020095231104219554, 0.0001804057449051752, 0.00015895752582629563, 0.00013671485022460805, 0.00011378888514693584, 9.029421266419985e-05, 6.634825719973655e-05, 4.207069865177487e-05, 1.758287424323659e-05, -6.992827911634486e-06, -3.153358049291102e-05, -5.591673085573418e-05, -8.002041403805415e-05, -0.00010372416183159738, -0.00012690950487197433, -0.00014946056473873136, -0.00017126463310607987, -0.00019221273504975537, -0.00021220017369464553, -0.00023112705348108363, -0.0002488987794345658, -0.0002654265299435834, -0.0002806277006826668, -0.00029442631746194847, -0.0003067534159398595, -0.0003175473863011857, -0.00032675428117781113, -0.00033432808527318706, -0.00034023094534296554, -0.00034443335938237347, -0.000346914324074784, -0.0003476614397645502, -0.0003466709724294548, -0.0003439478723430436, -0.0003395057493335689, -0.00033336680476319736, -0.0003255617205674444, -0.00031612950590940655, -0.0003051173022152016, -0.00029258014756503286, -0.0002785807016174318, -0.0002631889324414845, -0.0002464817668222288, -0.00022854270578696653, -0.00020946140727405848, -0.00018933323802998878, -0.0001682587969742802, -0.00014634341241444263, -0.00012369661562383288, -0.00010043159341344012, -7.666462243359749e-05, -5.251448803293298e-05, -2.8101890579054642e-05, -3.54884220812967e-06, 2.1021942981646812e-05, 4.5487662244930965e-05, 6.972603794716057e-05, 9.361592869802516e-05, 0.00011703793480608177, 0.0001398749950285043, 0.00016201297163346054, 0.00018334122085102424, 0.00020375314586155513, 0.00022314672955775752, 0.0002414250444177164, 0.0002584967369406086, 0.0002742764842239186, 0.0002886854204002248, 0.00030165153080225995, 0.0003131100118862422, 0.000323003595114609, 0.0003312828331794152, 0.0003379063471358749, 0.0003428410332108937, 0.00034606222825297913, 0.0003475538329966254, 0.00034730839252510633, 0.0003453271335295304, 0.00034161995817794046, 0.00033620539462509954, 0.00032911050441031107, 0.00032037074720609094, 0.0003100298035936671, 0.0002981393567510595, 0.00028475883414484513, 0.00026995511051661187, 0.00025380217364854977, 0.00023638075457865546, 0.0002177779241137039, 0.00019808665765658182, 0.00017740537052293967, 0.00015583742606961116, 0.0001334906190931335, 0.00011047663708029985, 8.691050200336877e-05, 6.290999544979214e-05, 3.8595069959615255e-05, 1.4087249512636181e-05, -1.0490977838360565e-05, -3.501677215272696e-05, -5.936755554578086e-05, -8.342162482290136e-05, -0.0001070587597419958, -0.00013016082386429318, -0.00015261235499046147, -0.00017430114223109802, -0.0001951187868274429, -0.0002149612439193796, -0.00023372934255301158, -0.00025132928132886006, -0.0002676730972134743, -0.00028267910517137333, -0.0002962723064200742, -0.00030838476326778327, -0.0003189559386603417, -0.00032793299874039867, -0.0003352710769066455, -0.0003409334980533662, -0.0003448919618695719, -0.0003471266842816068, -0.0003476264963323066, -0.0003463889000025194, -0.00034342008069599805, -0.0003387348763252657, -0.00033235670315296024, -0.0003243174387592969, -0.0003146572627205677, -0.00030342445579495343, -0.00029067515861930097, -0.0002764730911228792, -0.00026088923406046056, -0.0002440014742563988, -0.00022589421533274458, -0.00020665795586694675, -0.0001863888370874724, -0.0001651881623679254, -0.00014316189092119182, -0.00012042010822408717, -9.707647581927872e-05, -7.324766324432774e-05, -4.9052764927022606e-05, -2.4612704961311925e-05, -4.9632738718041146e-08, 2.4513687544185133e-05, 4.895449045103883e-05, 7.315062287716254e-05, 9.698115456063417e-05, 0.00012032698248170363, 0.0001430714261298016, 0.00016510081066304852, 0.00018630503504568085, 0.000206578122323891, 0.00022581874928984772, 0.00024393075288668063, 0.00026082361082345804, 0.000276412893998085, 0.00029062068846694925, 0.0003033759848523455, 0.00031461503324145226, 0.0003242816618031061, 0.00033232755752995216, 0.0003387125077028454, 0.00034340460087068405, 0.0003463803863411941, 0.00034762499138554277, 0.00034713219557100345, 0.000344904461850162, 0.0003409529242512841, 0.00033529733223136614, 0.00032796595196998786, 0.00031899542509729263, 0.0003084305855621609, 0.00029632423555585384, 0.00028273688161104373, 0.00026773643219518467, 0.0002513978583096277, 0.00023380281879077758, 0.00021503925218600514, 0.00019520093724408497, 0.00017438702421679157, 0.00015270153931416905, 0.00013025286479016594, 0.00010715319725712434, 8.351798693642208e-05, 5.946536064784711e-05, 3.511553142155507e-05, 1.0590197683320575e-05, -1.3988064984095505e-05, -3.849641646353663e-05, -6.281236604816209e-05, -8.681438463983475e-05, -0.0001103825121414684, -0.0001333989570076378, -0.00015574868495694786, -0.00017731999390382562, -0.00019800507223627424, -0.00021770053764936305, -0.0002363079538414081, -0.0002537343224904392, -0.00026989254805209566, -0.00028470187305592904, -0.000298088281724539, -0.00030998486989828624, -0.00032033217941673033, -0.00032907849528558133, -0.00033618010414394975, -0.00034160151274009666, -0.00034531562532376023, -0.0003473038790684672, -0.00034755633684699903, -0.0003460717368963291, -0.0003428574991238097, -0.0003379296880230906, -0.00033131293238511324, -0.0003230403022054572, -0.0003131531434032467, -0.00030170087117767797, -0.0002887407230349546, -0.00027433747271998125, -0.00025856310648256193, -0.00024149646329609743, -0.00022322284082693886, -0.00020383356912372967, -0.0001834255541574016, -0.00016210079349317393, -0.00013996586651518687, -0.00011713140175158418, -9.371152396231022e-05, -6.982328375303048e-05, -4.5586072565918044e-05, -2.1121025971133447e-05, 3.4495817587024098e-06, 2.800294876517575e-05, 5.2416359357577435e-05, 7.656779733574139e-05, 0.00010033655581688743, 0.00012360384051860433, 0.00014625336348281513, 0.00016817192427334124, 0.00018924997574228838, 0.00020938217153760095, 0.00022846789261538722, 0.0002464117501255508, 0.0002631240621573474, 0.0002785213019621324, 0.00029252651541311896, 0.0003050697056157178, 0.0003160881827462072, 0.0003255268773702699, 0.0003333386156754557, 0.00033948435524198126, 0.0003439333801735044, 0.00034666345461262466, 0.0003476609338738538, 0.0003469208326386211, 0.00034444684987148204, 0.0003402513503330006, 0.0003343553027817017, 0.00032678817517395656, 0.0003175877873855819, 0.0003068001221912393, 0.00029447909544634353, 0.00028068628662009093, 0.0002654906310263832, 0.0002489680752908489, 0.00023120119777591096, 0.00021227879586098447, 0.0001922954421405431, 0.00017135101175814018, 0.0001495501832387295, 0.0001270019153140844, 0.00010381890235609852, 8.011701113966702e-05, 5.601470175016114e-05, 3.163243552975195e-05, 7.092073021618858e-06, -1.7483735078932502e-05, -4.197216092246708e-05, -6.625081338881888e-05, -9.019834978775278e-05, -0.00011369508231966056, -0.00013662357626525093, -0.00015886923691453108, -0.0001803208823016575, -0.0002008712988831746, -0.00022041777738240773, -0.0002388626261219046, -0.00025611365927833205, -0.0002720846576195709, -0.0002866957994212832, -0.00029987405940926624, -0.0003115535737337131, -0.000321675969151268, -0.0003301906547696526, -0.00033705507489674707, -0.0003422349217304079, -0.000345704306826016, -0.0003474458904847744, -0.00034745096841608394, -0.00034571951524086536, -0.0003422601846184017, -0.0003370902659960677, -0.000330235598198106, -0.0003217304402853285, -0.0003116173003311729, -0.0002999467229698797, -0.0002867770367786044, -0.0002721740627560296, -0.0002562107853544756, -0.00023896698770966462, -0.00022052885289122908, -0.0002009885331668819, -0.00018044368943302965, -0.00015899700311371675, -0.0001367556629673894, -0.00011383082936637588, -9.033707872657063e-05, -6.639183086401565e-05, -4.211476214040421e-05, -1.7627207330556666e-05, 6.948446798715066e-06, 3.148937316751162e-05, 5.587291826239854e-05, 7.997721514848793e-05, 0.00010368179255026573, 0.00012686817695702928, 0.00014942048474366214, 0.00017122600134737576, 0.0001921757446057405, 0.0002121650094404894, 0.00023109389116481035, 0.0002488677847986801, 0.00026539785789670334, 0.0002806014945253032, 0.00029440270817030113, 0.0003067325215112089, 0.0003175293111641522, 0.00032673911567042966, 0.000334315905191405, 0.00034022181156182093, 0.00034442731755174647, 0.0003469114043912427, 0.0003476616568204306, 0.0003466743251399296, 0.00034395434395154405, 0.0003395153074955328, 0.0003333794017077244, 0.0003255772933360512, 0.000316147976670688, 0.0003051385786538256, 0.0002926041233431248, 0.00027860725690604244, 0.00026321793451948507, 0.00024651307073964024, 0.00022857615508940744, 0.00020949683478469104, 0.00018937046668505487, 0.00016829764070805123, 0.0001463836770891607, 0.00012373809999999518, 0.00010047409015557722, 7.670791914651882e-05, 5.255836832326041e-05, 2.814613513673856e-05, 3.593229902542456e-06, -2.097763399651826e-05, -4.54436534217173e-05, -6.968254923830807e-05, -9.357317745649171e-05, -0.00011699613469902482, -0.00013983435496939007, -0.00016197369473793194]
fig, ax = plt.subplots(1)
# time= np.arange(0, simutime, Ts)

# 目盛を内側に
plt.tick_params(direction='in')
# plt.ylim(-1.5, 1.5)
plt.ylim(-1.1, 1.1)


plt.rcParams["font.family"] = "Times New Roman"
plt.rcParams["mathtext.fontset"] = "stix"
plt.rcParams["font.size"] = 10
plt.rcParams['axes.linewidth'] = 1.0# 軸の線幅edge linewidth。囲みの太さ


plt.plot(ru, ls="-", color="y", linewidth="2", label="Classification NN")
# plt.plot(rx02, ls="-.", color="b", linewidth="2", label="optimizer")
plt.grid(True)
\

# ラベル　

plt.xlabel("$k$", fontsize=24)
# plt.ylabel("$u$", fontsize=18)
plt.ylabel("$u$", fontsize=24)
# plt.legend(loc='best')

# print(rx0)

# fig, ax = plt.subplots(2, 1)
# # time= np.arange(0, simutime, Ts)

# # 目盛を内側に
# ax[0].tick_params(direction='in')
# ax[1].tick_params(direction='in')


# plt.rcParams["font.family"] = "Times New Roman"
# plt.rcParams["mathtext.fontset"] = "stix"
# plt.rcParams["font.size"] = 10
# plt.rcParams['axes.linewidth'] = 1.0# 軸の線幅edge linewidth。囲みの太さ


# ax[0].plot(rx0, ls="-", color="b")
# ax[1].plot(ru, ls="-", color="g")

# # ax[1].plot(time, rx1, ls="-", label="Classification")

# # ax[2].plot(time, ru, ls="-", label="Classification")

# # plt.plot(time, noiseLi, label="noise")
# # plt.ylim(-5.0, 5.0)

# # 凡例・グリッド
# # plt.legend(loc='upper right', borderaxespad=0)
# ax[0].grid(True)
# ax[1].grid(True)
# # ax[0].ylim(-2.0, 2.0)
# # ax[1].ylim(-2.0, 2.0)
# # ax[1].legend(loc='upper right', borderaxespad=0)
# # ax[1].grid(True)
# # ax[2].legend(loc='lower right', borderaxespad=0)
# # ax[2].grid(True)

# # ラベル　

# ax[0].set_xlabel("$k$", fontsize=18)
# ax[0].set_ylabel("$x$", fontsize=18)
# ax[1].set_xlabel("$k$", fontsize=18)
# ax[1].set_ylabel("$u$", fontsize=18)


fig.tight_layout()
plt.show()

stop = [i for i in range(len(ru)) if abs(ru[i])<=0.01]
stopRate = 100 * (len(stop)/len(ru))
print(stopRate)
print(l2norm)
print(t2 - t1)

